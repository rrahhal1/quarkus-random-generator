#!/bin/bash
set -e  # Exit immediately on any error

echo "Starting assemble script for Eclipse Maven project..."

# Set Maven build arguments (can be customized via MAVEN_ARGS environment variable)
MAVEN_ARGS=${MAVEN_ARGS:-clean package -DskipTests}

# Build the project
echo "Building the project using Maven..."
mvn $MAVEN_ARGS

# Verify the build output
if [ ! -d "target" ]; then
    echo "Error: 'target' directory not found. Maven build might have failed."
    exit 1
fi

# Find the artifact (JAR/WAR)
ARTIFACT=$(ls target/*.jar 2>/dev/null || ls target/*.war 2>/dev/null)

if [ -z "$ARTIFACT" ]; then
    echo "Error: No JAR or WAR file found in the 'target' directory."
    exit 1
fi

# Create the deployment directory
DEPLOY_DIR="/deployments"
echo "Creating deployment directory at $DEPLOY_DIR"
mkdir -p $DEPLOY_DIR

# Copy the artifact to the deployment directory
echo "Copying $ARTIFACT to $DEPLOY_DIR/app.jar"
cp "$ARTIFACT" "$DEPLOY_DIR/app.jar"

echo "Assemble script completed successfully!"